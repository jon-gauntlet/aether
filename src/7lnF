#!/bin/bash
set -euo pipefail

# Check required dependencies
check_dependency() {
    if ! command -v "$1" >/dev/null 2>&1; then
        echo "Error: Required dependency '$1' is not installed" >&2
        exit 1
    fi
}

check_dependency kdialog

# Deep Work Mode Toggle
DEEP_STATE_FILE="$HOME/.cache/cursor/deep_mode"
CACHE_DIR="$(dirname "$DEEP_STATE_FILE")"

# Ensure cache directory exists
if ! mkdir -p "$CACHE_DIR" 2>/dev/null; then
    echo "Error: Failed to create cache directory: $CACHE_DIR" >&2
    exit 1
fi

toggle_deep_mode() {
    if [ -f "$DEEP_STATE_FILE" ]; then
        if ! rm "$DEEP_STATE_FILE" 2>/dev/null; then
            echo "Error: Failed to remove deep mode state file" >&2
            exit 1
        fi
        kdialog --passivepopup "Regular workflow restored" 3 --title "Deep Work Mode Disabled"
        if command -v qdbus >/dev/null 2>&1; then
            qdbus org.kde.plasmashell /org/kde/osd showText "notifications-disabled" "Deep Work Mode Disabled"
        fi
    else
        if ! touch "$DEEP_STATE_FILE" 2>/dev/null; then
            echo "Error: Failed to create deep mode state file" >&2
            exit 1
        fi
        kdialog --passivepopup "Minimizing distractions" 3 --title "Deep Work Mode Enabled"
        if command -v qdbus >/dev/null 2>&1; then
            qdbus org.kde.plasmashell /org/kde/osd showText "notifications-active" "Deep Work Mode Enabled"
        fi
        
        # Optional: Enable do-not-disturb if available
        if command -v dbus-send >/dev/null 2>&1; then
            dbus-send --session --dest=org.kde.plasmashell --type=method_call /org/kde/DoNotDisturb org.kde.DoNotDisturb.toggleDoNotDisturb
        fi
    fi
}

# Main execution
toggle_deep_mode 