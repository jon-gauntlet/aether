#!/bin/bash

# Get the real cursor path
REAL_CURSOR=$(which -a cursor | grep -v "$(dirname "$0")/cursor" | head -n1)

# Set resource limits silently
ulimit -n 524288 2>/dev/null  # File descriptors
ulimit -v 16777216 2>/dev/null  # Virtual memory (16GB)
ulimit -t unlimited 2>/dev/null  # CPU time
ulimit -m 16777216 2>/dev/null  # Max memory size
ulimit -l unlimited 2>/dev/null  # Max locked memory
ulimit -i 16384 2>/dev/null  # Pending signals

# Set process priority silently
renice -n -10 $$ > /dev/null 2>&1

# Set CPU governor if possible
if command -v cpupower >/dev/null 2>&1; then
    sudo cpupower frequency-set -g performance > /dev/null 2>&1
fi

# Quick kernel parameter optimizations (only if needed)
current_swappiness=$(cat /proc/sys/vm/swappiness)
if [ "$current_swappiness" -gt 10 ]; then
    sudo sysctl -w vm.swappiness=10 > /dev/null 2>&1
fi

# Set process scheduling silently
sudo chrt -f -p 50 $$ > /dev/null 2>&1

# Handle workspace argument
if [ -n "$1" ] && [ -d "$1" ]; then
    export CURSOR_WORKSPACE="$1"
elif [ -n "$1" ]; then
    mkdir -p "$1" 2>/dev/null
    export CURSOR_WORKSPACE="$1"
else
    export CURSOR_WORKSPACE="$(pwd)"
fi

# Export optimization environment variables
export ELECTRON_ENABLE_LOGGING=1
export ELECTRON_NO_ATTACH_CONSOLE=1
export ELECTRON_NO_ASAR=1
export NODE_OPTIONS="--max-old-space-size=8192"

# Extract AppImage if needed (only once)
if [ ! -d "$HOME/.local/share/cursor-extracted" ]; then
    "$REAL_CURSOR" --appimage-extract >/dev/null 2>&1
    mv squashfs-root "$HOME/.local/share/cursor-extracted"
fi

# Use extracted version if available
if [ -d "$HOME/.local/share/cursor-extracted" ]; then
    exec "$HOME/.local/share/cursor-extracted/cursor" "$@"
else
    # Fallback to regular cursor
    exec "$REAL_CURSOR" "$@"
fi 