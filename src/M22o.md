## 3 Cross-Site Request Forgery (CSRF)

### 3.1 What is CSRF?
- CSRF is an attack that forces a user to execute unwanted actions on a web app in which they're authenticated
- Inherits identity and privileges of victim to perform an undesired function on victim's behalf
- Unauthorized commands transmitted from a website trusted by the user to a website that trusts the user
- CSRF attacks target state-changing requests like changing email, transferring funds, etc.

### 3.2 CSRF Countermeasures
- _Synchronizer token pattern_
  - Include a token in the session and as a hidden field in forms
  - Verify the token on the server before processing form submission
  - Rails enables this by default with `protect_from_forgery` in `ApplicationController`
- _SameSite Cookie Attribute_
  - Prevents the browser from sending the session cookie along with cross-site requests
  - Helps protect against CSRF attacks
  - Rails sets SameSite protection to `Lax` by default
- _Verifying Same Origin with Standard Headers_
  - Check standard headers to verify origin of a request
  - Use `Origin` header for normal requests, `Referer` header for GET requests
  - Verify that origin/referer matches expected value before processing request

### 3.3 CSRF Protection in Rails
- Rails has built-in CSRF protection with `protect_from_forgery`
- Enabled by default in `ApplicationController`
- Includes a random token in the session and in a hidden field in every form
- Raises an exception if the token doesn't match what's expected
- Can be disabled for specific controller actions with `skip_before_action :verify_authenticity_token`

### 3.4 Custom CSRF Handling
- Can customize CSRF behavior by overriding methods in `ApplicationController`
- `handle_unverified_request` - called when a request fails CSRF verification
- `valid_authenticity_token?` - verify the token for non-GET requests that don't have a form
- `verified_request?` - returns true if a request is GET or HEAD, or if CSRF token is valid

## Key Recommendations for CSRF Protection in @codebase[app]
Based on [Section 3 - Cross-Site Request Forgery (CSRF)](https://guides.rubyonrails.org/security.html#cross-site-request-forgery-csrf) of the Rails Security Guide.

1. Ensure that `protect_from_forgery` is enabled in `ApplicationController` and that all forms and AJAX requests in the `app/views` directory include the CSRF token.

2. Audit the `app/controllers` directory for any instances of `skip_before_action :verify_authenticity_token`. Refactor these to use `protect_from_forgery with: :null_session` instead, if the action doesn't require session access.

3. In `app/controllers/api_controller.rb`, ensure that any actions skipping CSRF protection are safe to do so and don't introduce security vulnerabilities. Consider implementing alternative security measures for these actions, such as API tokens or OAuth.

4. Update the JavaScript code in `app/javascript` to include the CSRF token in the `X-CSRF-Token` header for all AJAX requests.

5. Audit the `app/controllers` directory for any state-changing actions (e.g., create, update, destroy) that respond to GET requests. Refactor these to use POST, PATCH, PUT, or DELETE instead.

6. If the application allows cross-origin requests (CORS), ensure that the CORS configuration in `config/initializers/cors.rb` is properly set up and only allows trusted domains. Consider implementing additional security measures for CORS-enabled actions, such as strict origin checking or CSRF tokens for cross-origin requests.

7. Review the third-party gems used in the application (as listed in the `Gemfile`) and ensure they are up to date and free of known CSRF vulnerabilities. Pay special attention to gems that handle authentication, authorization, or session management.


