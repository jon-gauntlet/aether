#!/usr/bin/env zsh

# BrainLift Manager (brain)
# Usage: brain [command] [args]
#   brain add     # Add to BrainLift
#   brain view    # View BrainLift
#   brain spiky   # Add SpikyPOV

# Exit if being sourced
[[ $ZSH_EVAL_CONTEXT == *:file:* ]] && return 0

# Colors
[[ -z "$NO_COLOR" ]] && {
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m'
}

# Data storage (minimal)
DATA_DIR="$HOME/.local/share/gauntlet"
BRAIN_DIR="$DATA_DIR/brain"
SPIKY_FILE="$BRAIN_DIR/spiky.md"
mkdir -p "$BRAIN_DIR"
touch "$SPIKY_FILE"

# Show help if needed
[[ "$1" == "help" || $# -eq 0 ]] && {
    cat << EOF
BrainLift Manager

Quick Start:
  brain add <topic>   Add to BrainLift
  brain view <topic>  View BrainLift
  brain spiky        Add SpikyPOV
  brain search       Search BrainLift

Tips shown during use!
EOF
    exit 0
}

# Add to BrainLift
add_brain() {
    local topic=$1
    local file="$BRAIN_DIR/${topic}.md"
    
    # Create topic file if needed
    [[ -f $file ]] || {
        cat > "$file" << EOF
# $topic BrainLift
Created: $(date +%Y-%m-%d)

## Purpose
What do you want to learn about $topic?

## Experts & Sources
Who/what to learn from?

## Key Insights
What have you learned?

## SpikyPOVs
What unique perspectives do you have?
EOF
    }
    
    # Open in editor
    ${EDITOR:-vim} "$file"
    echo -e "${GREEN}✓ Updated $topic BrainLift${NC}"
}

# Add SpikyPOV
add_spiky() {
    echo -e "\n${YELLOW}Enter SpikyPOV:${NC}"
    read -r pov
    echo -e "\n## $(date +%Y-%m-%d\ %H:%M)\n$pov" >> "$SPIKY_FILE"
    echo -e "${GREEN}✓ Added SpikyPOV${NC}"
}

# View BrainLift
view_brain() {
    local topic=${1:-}
    if [[ -n "$topic" ]]; then
        local file="$BRAIN_DIR/${topic}.md"
        [[ -f $file ]] && cat "$file" || echo "Topic not found: $topic"
    else
        echo -e "\n${BLUE}Available Topics:${NC}"
        ls -1 "$BRAIN_DIR" | grep '.md$' | sed 's/.md$//'
        echo -e "\n${BLUE}Recent SpikyPOVs:${NC}"
        tail -n 5 "$SPIKY_FILE"
    fi
}

# Search BrainLift
search_brain() {
    echo -e "\n${YELLOW}Search term:${NC}"
    read -r term
    echo -e "\n${BLUE}Results:${NC}"
    grep -r -i "$term" "$BRAIN_DIR"
}

# Handle commands
case $1 in
    add) shift; add_brain "$1" ;;
    spiky) add_spiky ;;
    view) shift; view_brain "$1" ;;
    search) search_brain ;;
    *) show_help ;;
esac 