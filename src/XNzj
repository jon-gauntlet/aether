#!/bin/bash
set -euo pipefail

# Configuration
POSSIBLE_PATHS=(
    "/opt/cursor-bin/cursor-bin.AppImage"
    "/opt/Cursor/cursor.AppImage"
    "/usr/lib/cursor/cursor.AppImage"
    "$HOME/.local/share/cursor/cursor.AppImage"
    "$HOME/Applications/cursor.AppImage"
)

XDG_CONFIG_HOME=${XDG_CONFIG_HOME:-~/.config}

# Find AppImage
APPIMAGE_PATH=""
for path in "${POSSIBLE_PATHS[@]}"; do
    if [ -f "$path" ] && [ -x "$path" ]; then
        APPIMAGE_PATH="$path"
        break
    fi
done

# Error if no AppImage found
if [ -z "$APPIMAGE_PATH" ]; then
    echo "Error: No Cursor AppImage found in any of these locations:" >&2
    printf '%s\n' "${POSSIBLE_PATHS[@]}" >&2
    echo "" >&2
    echo "Please ensure Cursor is installed correctly." >&2
    echo "You can download it from: https://cursor.sh" >&2
    exit 1
fi

# Verify permissions
if [ ! -x "$APPIMAGE_PATH" ]; then
    echo "Error: Cursor AppImage is not executable" >&2
    echo "Attempting to fix permissions..." >&2
    sudo chmod +x "$APPIMAGE_PATH" || {
        echo "Failed to set executable permissions" >&2
        exit 1
    }
fi

# Load user flags if they exist
if [[ -f $XDG_CONFIG_HOME/cursor-flags.conf ]]; then
    CURSOR_USER_FLAGS="$(sed 's/#.*//' $XDG_CONFIG_HOME/cursor-flags.conf | tr '\n' ' ')"
else
    CURSOR_USER_FLAGS=""
fi

# Launch with error handling
if ! exec "$APPIMAGE_PATH" "$@" $CURSOR_USER_FLAGS; then
    echo "Error: Failed to launch Cursor" >&2
    echo "AppImage path: $APPIMAGE_PATH" >&2
    echo "Please check the installation and try again" >&2
    exit 1
fi 