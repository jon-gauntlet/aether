#!/bin/bash

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

# Function to test sudo command
test_sudo() {
    local cmd="$1"
    local desc="$2"
    echo -n "Testing: $desc... "
    if sudo -n bash -c "$cmd" > /dev/null 2>&1; then
        echo -e "${GREEN}✓${NC}"
        return 0
    else
        echo -e "${RED}✗${NC}"
        echo "Failed command: $cmd"
        return 1
    fi
}

# Test core optimization commands
echo "Testing core optimization commands..."
test_sudo "/home/jon/scripts/cursor/cursor-optimize cpupower" "CPU governor control"
test_sudo "/home/jon/scripts/cursor/cursor-optimize sysctl vm.swappiness=1" "Sysctl control"
test_sudo "/home/jon/scripts/cursor/cursor-optimize optimize $$" "Process optimization"

# Verify process optimization (with output)
echo -n "Testing: Process verification... "
if sudo -n /home/jon/scripts/cursor/cursor-optimize verify $$; then
    echo -e "${GREEN}✓${NC}"
else
    echo -e "${RED}✗${NC}"
fi

# Test direct commands
echo -e "\nTesting direct command access..."
test_sudo "chrt -f -p 50 $$" "Process scheduling"
test_sudo "renice -n -10 -p $$" "Process priority"
test_sudo "ionice -c 1 -n 0 -p $$" "IO priority"
test_sudo "taskset -pc 0-7 $$" "CPU affinity"
test_sudo "cpupower frequency-set -g performance" "CPU frequency"
test_sudo "sysctl -w vm.swappiness=1" "Direct sysctl"

# Test systemd controls
echo -e "\nTesting systemd controls..."
test_sudo "systemctl daemon-reload" "Systemd reload"
test_sudo "systemctl status cursor-context.slice" "Systemd status"

# Test file operations
echo -e "\nTesting file operations..."
test_sudo "cp /home/jon/scripts/cursor/cursor-optimize /etc/systemd/system/" "System file copy"
test_sudo "chmod +x /home/jon/scripts/cursor/cursor-optimize" "Permission setting"
test_sudo "chown jon:jon /home/jon/.local/share/cursor" "Ownership setting"

# Test memory management
echo -e "\nTesting memory management..."
test_sudo "tee /proc/sys/vm/drop_caches <<< 3" "Drop caches"
test_sudo "tee /proc/sys/vm/compact_memory <<< 1" "Compact memory"

# Test monitoring access
echo -e "\nTesting monitoring access..."
test_sudo "cat /proc/sys/vm/swappiness" "Sysctl reading"

# Test scheduler parameters (try both possible locations)
echo -e "\nTesting scheduler parameters..."
if [ -f /proc/sys/kernel/sched_latency_ns ]; then
    test_sudo "cat /proc/sys/kernel/sched_latency_ns" "Scheduler latency (ns)"
elif [ -f /proc/sys/kernel/sched_latency_us ]; then
    test_sudo "cat /proc/sys/kernel/sched_latency_us" "Scheduler latency (us)"
else
    echo "Note: Scheduler latency parameter not found (this is normal on some systems)"
fi

# Summary
echo -e "\nVerification complete!"
failed_count=$(($? != 0))
if [ $failed_count -eq 0 ]; then
    echo -e "${GREEN}All tests passed!${NC}"
else
    echo -e "${RED}Some tests failed. Please check the output above.${NC}"
fi 